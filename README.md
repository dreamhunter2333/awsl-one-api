# AWSL One API

ä¸€ä¸ªåŸºäº Cloudflare Workers çš„ OpenAI API ä»£ç†æœåŠ¡ï¼Œæ”¯æŒå¤šæ¸ é“ç®¡ç†ã€Token ç®¡ç†å’Œä½¿ç”¨é‡ç»Ÿè®¡ã€‚

## âœ¨ ç‰¹æ€§

- ğŸš€ **åŸºäº Cloudflare Workers**ï¼šæ— æœåŠ¡å™¨æ¶æ„ï¼Œå…¨çƒè¾¹ç¼˜éƒ¨ç½²
- ğŸ” **å¤šæ¸ é“æ”¯æŒ**ï¼šæ”¯æŒ Azure OpenAI å’Œ OpenAIï¼Œåç»­ä¼šç»§ç»­å¢åŠ å…¶ä»– AI æœåŠ¡æä¾›å•†
- ğŸ« **Token ç®¡ç†**ï¼šå®Œæ•´çš„ API Token ç”Ÿæˆã€ç®¡ç†å’Œé…é¢æ§åˆ¶
- ğŸ“Š **ä½¿ç”¨é‡ç»Ÿè®¡**ï¼šå®æ—¶ç»Ÿè®¡ API ä½¿ç”¨é‡å’Œè´¹ç”¨
- ğŸ’° **å®šä»·ç®¡ç†**ï¼šçµæ´»çš„æ¨¡å‹å®šä»·é…ç½®
- ğŸ¨ **Web ç®¡ç†ç•Œé¢**ï¼šç›´è§‚çš„ Web ç•Œé¢è¿›è¡Œé…ç½®ç®¡ç†
- ğŸ§ª **API æµ‹è¯•å·¥å…·**ï¼šå†…ç½® API æµ‹è¯•åŠŸèƒ½ï¼Œæ”¯æŒå®æ—¶è°ƒè¯•
- ğŸ“š **OpenAPI æ–‡æ¡£**ï¼šè‡ªåŠ¨ç”Ÿæˆçš„ API æ–‡æ¡£

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```mermaid
flowchart LR
    subgraph Clients["å®¢æˆ·ç«¯"]
        A[Client Apps]
    end

    subgraph CF["Cloudflare Workers"]
        B[AWSL One API]
        D[(Cloudflare D1<br/>Database)]
    end

    subgraph Providers["AI æœåŠ¡æä¾›å•†"]
        C1[Azure OpenAI]
        C2[OpenAI]
    end

    A -->|API Request| B
    B -->|Proxy| C1
    B -->|Proxy| C2
    B <-->|Read/Write| D
```

<details>
<summary>ğŸ“ é¡¹ç›®ç»“æ„</summary>

```text
awsl-one-api/
â”œâ”€â”€ src/                          # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ admin/                    # ç®¡ç†æ¥å£
â”‚   â”‚   â”œâ”€â”€ channel_api.ts        # é¢‘é“ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ token_api.ts          # Token ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ pricing_api.ts        # å®šä»·ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ db_api.ts             # æ•°æ®åº“ç®¡ç† API
â”‚   â”‚   â””â”€â”€ index.ts              # ç®¡ç†æ¥å£è·¯ç”±
â”‚   â”œâ”€â”€ providers/                # AI æœåŠ¡æä¾›å•†
â”‚   â”‚   â”œâ”€â”€ azure-openai-proxy.ts # Azure OpenAI ä»£ç†
â”‚   â”‚   â”œâ”€â”€ openai-proxy.ts       # OpenAI ä»£ç†
â”‚   â”‚   â””â”€â”€ index.ts              # æä¾›å•†è·¯ç”±
â”‚   â”œâ”€â”€ db/                       # æ•°æ®åº“ç›¸å…³
â”‚   â”œâ”€â”€ model/                    # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ constants.ts              # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ utils.ts                  # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ index.ts                  # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ public/                       # é™æ€æ–‡ä»¶
â”‚   â””â”€â”€ index.html                # Web ç®¡ç†ç•Œé¢
â”œâ”€â”€ type.d.ts                     # ç±»å‹å®šä¹‰
â”œâ”€â”€ wrangler.toml                 # Cloudflare Workers é…ç½®
â””â”€â”€ package.json                  # é¡¹ç›®é…ç½®
```

</details>

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js 18+
- pnpm
- Cloudflare Workers è´¦æˆ·

### å®‰è£…ä¾èµ–

```bash
pnpm install
```

### é…ç½®ç¯å¢ƒ

1. å¤åˆ¶ `wrangler.toml.template` ä¸º `wrangler.toml` å¹¶ä¿®æ”¹é…ç½®ï¼š

```toml
name = "awsl-one-api"
main = "src/index.ts"
compatibility_date = "2025-04-28"
routes = [
    { pattern = "your-domain.com", custom_domain = true },
]

[vars]
ADMIN_TOKEN = "your-secure-admin-token-here"

[assets]
directory = "public"
binding = "ASSETS"
run_worker_first = true

[[d1_databases]]
binding = "DB"
database_name = "your-database-name"
database_id = "your-database-id"
```

1. åˆ›å»º Cloudflare D1 æ•°æ®åº“ï¼š

```bash
wrangler d1 create awsl-one-api
```

### æœ¬åœ°å¼€å‘

```bash
pnpm dev
```

### éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

```bash
pnpm run deploy
```

<details>
<summary>ğŸ“– ä½¿ç”¨æŒ‡å—</summary>

### åˆå§‹åŒ–æ•°æ®åº“

é¦–æ¬¡éƒ¨ç½²åï¼Œéœ€è¦é€šè¿‡ Web ç•Œé¢åˆå§‹åŒ–æ•°æ®åº“ï¼š

1. è®¿é—® `https://your-domain.com`
2. ä½¿ç”¨ç®¡ç†å‘˜ Token ç™»å½•
3. åˆ‡æ¢åˆ° **ğŸ“Š æ•°æ®åº“** æ ‡ç­¾
4. ç‚¹å‡» **ğŸ”„ åˆå§‹åŒ–æ•°æ®åº“** æŒ‰é’®

### é¢‘é“é…ç½®

1. åœ¨ Web ç•Œé¢åˆ‡æ¢åˆ° **ğŸ”— é¢‘é“ç®¡ç†** æ ‡ç­¾
2. ç‚¹å‡» **â• æ·»åŠ é¢‘é“** æŒ‰é’®
3. é€‰æ‹©é¢‘é“ç±»å‹ï¼ˆAzure OpenAI æˆ– OpenAIï¼‰
4. å¡«å†™é¢‘é“æ ‡è¯†å’Œé…ç½®ä¿¡æ¯ï¼š
   - å¯¹äº OpenAIï¼šå¡«å†™åŸºæœ¬ä¿¡æ¯ï¼ˆåç§°ã€ç«¯ç‚¹ã€APIå¯†é’¥ï¼‰å’Œæ¨¡å‹æ˜ å°„é…ç½®
   - å¯¹äº Azure OpenAIï¼šè¿˜éœ€è¦é…ç½® API ç‰ˆæœ¬å’Œæ¨¡å‹éƒ¨ç½²æ˜ å°„
5. ç‚¹å‡» **ğŸ’¾ ä¿å­˜é¢‘é“** æŒ‰é’®

**æç¤º**ï¼šç³»ç»Ÿä¼šæ ¹æ®é€‰æ‹©çš„é¢‘é“ç±»å‹è‡ªåŠ¨æ˜¾ç¤ºç›¸åº”çš„é…ç½®å­—æ®µã€‚

### Token åˆ›å»ºå’Œä½¿ç”¨

1. åœ¨ Web ç•Œé¢åˆ‡æ¢åˆ° **ğŸ”‘ ä»¤ç‰Œç®¡ç†** æ ‡ç­¾
2. ç‚¹å‡» **â• æ·»åŠ ä»¤ç‰Œ** æŒ‰é’®
3. å¡«å†™ä»¤ç‰Œåç§°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆ `sk-` å¼€å¤´çš„ Token
4. é…ç½®å…è®¸è®¿é—®çš„é¢‘é“å’Œé…é¢
5. ç‚¹å‡» **ğŸ’¾ ä¿å­˜ä»¤ç‰Œ** æŒ‰é’®
6. ä½¿ç”¨ **ğŸ“‹ å¤åˆ¶** æŒ‰é’®è·å– Token ç”¨äº API è°ƒç”¨

### OpenAI å…¼å®¹ API

æœ¬é¡¹ç›®æä¾›å®Œå…¨å…¼å®¹çš„ OpenAI API æ¥å£ï¼š

```bash
curl https://your-domain.com/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_TOKEN" \
  -d '{
    "model": "gpt-4",
    "messages": [
      {
        "role": "user",
        "content": "Hello, world!"
      }
    ]
  }'
```

### API æµ‹è¯•å·¥å…·

ç®¡ç†ç•Œé¢å†…ç½®äº†å¼ºå¤§çš„ API æµ‹è¯•å·¥å…·ï¼Œæ— éœ€é¢å¤–å·¥å…·å³å¯è¿›è¡Œ API è°ƒè¯•ï¼š

#### åŠŸèƒ½ç‰¹æ€§

- **ğŸš€ ä¸€é”®æµ‹è¯•**ï¼šç›´æ¥åœ¨ Web ç•Œé¢ä¸­æµ‹è¯• API è°ƒç”¨
- **ğŸ“ JSON ç¼–è¾‘å™¨**ï¼šæ”¯æŒ JSON æ ¼å¼éªŒè¯å’Œè¯­æ³•é«˜äº®
- **âš¡ å®æ—¶å“åº”**ï¼šæ˜¾ç¤ºå“åº”æ—¶é—´ã€çŠ¶æ€ç å’Œå®Œæ•´å“åº”å†…å®¹
- **ğŸ” é”™è¯¯è¯Šæ–­**ï¼šè‡ªåŠ¨åŒºåˆ† HTTP é”™è¯¯å’Œ JSON å“åº”ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
- **ğŸ“‹ ä¸€é”®å¤åˆ¶**ï¼šæ”¯æŒå¤åˆ¶ Token å’Œå“åº”å†…å®¹

#### ä½¿ç”¨æ­¥éª¤

1. è®¿é—®ç®¡ç†ç•Œé¢ï¼Œåˆ‡æ¢åˆ° **ğŸ§ª API æµ‹è¯•** æ ‡ç­¾
2. è¾“å…¥ä½ çš„ API Tokenï¼ˆå¯ä»ä»¤ç‰Œç®¡ç†é¡µé¢å¤åˆ¶ï¼‰
3. ç¼–è¾‘è¯·æ±‚ JSONï¼ˆé¢„å¡«å……æ ‡å‡†æ ¼å¼ï¼‰
4. ç‚¹å‡» **ğŸš€ å‘é€è¯·æ±‚** æŒ‰é’®
5. æŸ¥çœ‹å“åº”ç»“æœå’ŒçŠ¶æ€ä¿¡æ¯

</details>

## ğŸ› ï¸ ç®¡ç†åŠŸèƒ½

### Web ç®¡ç†ç•Œé¢

è®¿é—® `https://your-domain.com` å³å¯ä½¿ç”¨ Web ç®¡ç†ç•Œé¢ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š

- **ğŸ“Š æ•°æ®åº“ç®¡ç†**ï¼šä¸€é”®åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„
- **ğŸ”— é¢‘é“é…ç½®ç®¡ç†**ï¼šæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤ AI æœåŠ¡æä¾›å•†é¢‘é“ï¼ˆæ”¯æŒ Azure OpenAI å’Œ OpenAIï¼‰
- **ğŸ”‘ API Token ç®¡ç†**ï¼šç”Ÿæˆã€ç®¡ç†å’Œç›‘æ§ API Token ä½¿ç”¨æƒ…å†µ
- **ğŸ’° å®šä»·é…ç½®**ï¼šçµæ´»é…ç½®ä¸åŒæ¨¡å‹çš„å®šä»·ç­–ç•¥
- **ğŸ§ª API æµ‹è¯•å·¥å…·**ï¼šå†…ç½® API æµ‹è¯•ç•Œé¢ï¼Œæ”¯æŒå®æ—¶è°ƒè¯•å’Œé”™è¯¯æ’æŸ¥

#### ç®¡ç†ç•Œé¢ç‰¹æ€§

- **ç°ä»£åŒ– UI**ï¼šå“åº”å¼è®¾è®¡ï¼Œæ”¯æŒæ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡
- **å®æ—¶åé¦ˆ**ï¼šæ“ä½œç»“æœå³æ—¶æ˜¾ç¤ºï¼Œæ”¯æŒæ‚¬æµ®æç¤º
- **æ™ºèƒ½è¡¨å•**ï¼šè‡ªåŠ¨ç”Ÿæˆ Tokenã€JSON æ ¼å¼éªŒè¯ã€ä¸€é”®å¤åˆ¶åŠŸèƒ½ï¼Œæ ¹æ®é¢‘é“ç±»å‹æ™ºèƒ½æ˜¾ç¤ºé…ç½®å­—æ®µ
- **å®‰å…¨è®¤è¯**ï¼šç®¡ç†å‘˜ Token è®¤è¯ï¼Œæ•°æ®å®‰å…¨ä¿æŠ¤

## ğŸ”§ é…ç½®è¯´æ˜

### æ¸ é“é…ç½®

ç›®å‰æ”¯æŒä»¥ä¸‹ AI æœåŠ¡æä¾›å•†ï¼š

#### Azure OpenAI é…ç½®

```json
{
  "name": "My Azure OpenAI",
  "type": "azure-openai",
  "endpoint": "https://your-resource.openai.azure.com/",
  "api_key": "your-azure-api-key",
  "api_version": "2024-02-15-preview",
  "deployment_mapper": {
    "gpt-4": "gpt-4-deployment-name",
    "gpt-3.5-turbo": "gpt-35-turbo-deployment-name"
  }
}
```

#### OpenAI é…ç½®

```json
{
  "name": "My OpenAI Channel",
  "type": "openai",
  "endpoint": "https://api.openai.com/v1/",
  "api_key": "sk-your-openai-api-key",
  "deployment_mapper": {
    "gpt-4": "gpt-4",
    "gpt-3.5-turbo": "gpt-3.5-turbo"
  }
}
```

**é…ç½®è¯´æ˜**ï¼š

- `name`: é¢‘é“æ˜¾ç¤ºåç§°
- `type`: æœåŠ¡æä¾›å•†ç±»å‹ï¼ˆ`azure-openai` æˆ– `openai`ï¼‰
- `endpoint`: API ç«¯ç‚¹åœ°å€
- `api_key`: API å¯†é’¥
- `api_version`: API ç‰ˆæœ¬ï¼ˆä»… Azure OpenAI éœ€è¦ï¼‰
- `deployment_mapper`: æ¨¡å‹åç§°æ˜ å°„å…³ç³»ï¼ˆç”¨äºè‡ªå®šä¹‰æ¨¡å‹åç§°æ˜ å°„ï¼‰

### Token é…ç½®

æ”¯æŒè¯¦ç»†çš„ Token é…ç½®ï¼ŒåŒ…æ‹¬åç§°ã€è®¿é—®æƒé™å’Œé…é¢ç®¡ç†ï¼š

```json
{
  "name": "ç”¨æˆ·ä»¤ç‰Œ1",
  "channel_keys": ["azure-openai-1", "azure-openai-2"],
  "total_quota": 1000000
}
```

**é…ç½®è¯´æ˜**ï¼š

- `name`: Token åç§°ï¼Œä¾¿äºç®¡ç†è¯†åˆ«
- `channel_keys`: å…è®¸è®¿é—®çš„é¢‘é“åˆ—è¡¨ï¼Œç©ºæ•°ç»„è¡¨ç¤ºå…è®¸æ‰€æœ‰é¢‘é“
- `total_quota`: æ€»é…é¢ï¼ˆåŸºç¡€å•ä½ï¼š1ç™¾ä¸‡ token = $1.00ï¼‰

## ğŸ“Š ç›‘æ§ä¸ç»Ÿè®¡

- **ä½¿ç”¨é‡ç»Ÿè®¡**ï¼šè‡ªåŠ¨è®°å½•æ¯æ¬¡ API è°ƒç”¨çš„ Token ä½¿ç”¨é‡
- **è´¹ç”¨è®¡ç®—**ï¼šåŸºäºæ¨¡å‹å®šä»·è‡ªåŠ¨è®¡ç®—è´¹ç”¨
- **é…é¢ç®¡ç†**ï¼šæ”¯æŒ Token çº§åˆ«çš„é…é¢é™åˆ¶
- **å®æ—¶ç›‘æ§**ï¼šWeb ç•Œé¢å®æ—¶æ˜¾ç¤ºä½¿ç”¨æƒ…å†µå’Œå‰©ä½™é…é¢

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

- **é›¶é…ç½®éƒ¨ç½²**ï¼šåŸºäº Cloudflare Workersï¼Œæ— éœ€æœåŠ¡å™¨ç»´æŠ¤
- **å…¨çƒåŠ é€Ÿ**ï¼šåˆ©ç”¨ Cloudflare å…¨çƒè¾¹ç¼˜ç½‘ç»œï¼Œä½å»¶è¿Ÿè®¿é—®
- **æˆæœ¬ä¼˜åŒ–**ï¼šæŒ‰éœ€è®¡è´¹ï¼Œæ— å›ºå®šæœåŠ¡å™¨æˆæœ¬
- **é«˜å¯ç”¨æ€§**ï¼šCloudflare åŸºç¡€è®¾æ–½ä¿è¯ 99.9% å¯ç”¨æ€§
- **å®‰å…¨å¯é **ï¼šå†…ç½® Token è®¤è¯å’Œé…é¢ç®¡ç†æœºåˆ¶

## ğŸ”’ å®‰å…¨æ€§

- **Token è®¤è¯**ï¼šæ‰€æœ‰ API è°ƒç”¨éœ€è¦æœ‰æ•ˆçš„ Bearer Token
- **ç®¡ç†å‘˜è®¤è¯**ï¼šç®¡ç†æ¥å£ä½¿ç”¨ç‹¬ç«‹çš„ç®¡ç†å‘˜ Token
- **CORS æ”¯æŒ**ï¼šé…ç½®è·¨åŸŸè®¿é—®ç­–ç•¥

## ğŸ“š API æ–‡æ¡£

éƒ¨ç½²åå¯è®¿é—®ä»¥ä¸‹åœ°å€æŸ¥çœ‹å®Œæ•´ API æ–‡æ¡£ï¼š

- Swagger UI: `https://your-domain.com/api/docs`
- ReDoc: `https://your-domain.com/api/redocs`
- OpenAPI JSON: `https://your-domain.com/api/openapi.json`

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ™‹â€â™‚ï¸ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·åˆ›å»º Issue æˆ–è”ç³»ç»´æŠ¤è€…ã€‚
